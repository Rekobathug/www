<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Orders</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="layout.css" type="text/css"/>
        <script src="functions.js"></script>
        <script src="jquery-3.2.0.min.js"></script>
        <base target="_parent">
        <script>
            if ((document.URL.indexOf('file')) >= 0) {
            } else if (top.location === self.location) {
                top.location.href = "home.html";
            }

            window.onload = get_orders("ALL");

            function get_orders(orders) {

                var request = new XMLHttpRequest();
                var order;
                //Create event handler that specifies what should happen when server responds
                request.onload = function () {
                    if (request.status === 200) {
                        var orders = JSON.parse(request.responseText);
                        if (orders.hasOwnProperty("message")) {
                            document.getElementById("msgorders").innerHTML = orders["message"];
                            document.getElementById("table-orders").style.display="none";

                        } else {
                            // Find a <table> element with id="myTable":
                            var table = document.getElementById("table-orders");
                            while (table.rows.length > 1) {
                                table.deleteRow(1);
                            }
                            for (var i = 0; i < orders.length; i++) {
                                order = orders[i];
                                var row = table.insertRow();
                                var cell1 = row.insertCell(0);
                                var cell2 = row.insertCell(1);
                                var cell3 = row.insertCell(2);
                                cell1.innerHTML = order['idorder'];
                                cell2.innerHTML = order['date'];
                                cell3.innerHTML = order['total'];
                                row.setAttribute("onclick", "get_order_details(" + order['idorder'] + ");");
                                ;
                            }
                        }
                    } else {
                        alert("Error communicating with server: " + request.status);
                    }
                };
                //Set up and send request
                request.open("POST", "PHP_Orders/get_orders.php");
                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                request.send("orders=" + orders);
            }

              function get_order_details(id) {

                var request = new XMLHttpRequest();
                //Create event handler that specifies what should happen when server responds
                request.onload = function () {
                    if (request.status === 200) {
                        alert(request.responseText);
                        var order = JSON.parse(request.responseText);
                        if (orders.hasOwnProperty("message")) {
                            document.getElementById("msgorderdetails").innerHTML = orders["message"];
                            alert(order["message"]);
                        } else {
                          document.getElementById("date").innerHTML ="Date of purchase :"+ order["date"];
                          document.getElementById("numberofitems").innerHTML ="numberofitems :" + order["numberofitems"];
                          document.getElementById("total").innerHTML ="Total : "+ order["total"];
                          get_order_items(id);
                          visibility(['orders-details','orders']);
                        }
                    } else {
                        alert("Error communicating with server: " + request.status);
                    }
                };
                //Set up and send request
                request.open("POST", "PHP_Orders/get_order_details.php");
                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                request.send("idorder=" + id);

              }

              function get_order_items(id) {

                  var request = new XMLHttpRequest();
                  var event;
                  //Create event handler that specifies what should happen when server responds
                  request.onload = function () {
                      if (request.status === 200) {
                          var orders = JSON.parse(request.responseText);
                          if (orders.hasOwnProperty("message")) {
                              document.getElementById("msgorders").innerHTML = orders["message"];
                              alert(orders["message"]);

                          } else {
                              // Find a <table> element with id="myTable":
                              var table = document.getElementById("table-order-details");
                              while (table.rows.length > 1) {
                                  table.deleteRow(1);
                              }
                              for (var i = 0; i < orders.length; i++) {
                                  event = orders[i];
                                  var row = table.insertRow();
                                  var cell1 = row.insertCell(0);
                                  var cell2 = row.insertCell(1);
                                  var cell3 = row.insertCell(2);
                                  var cell4 = row.insertCell(3);
                                  cell1.innerHTML = event['eventname'];
                                  cell2.innerHTML = event['dateofevent'];
                                  cell3.innerHTML = event['price'];
                                  cell4.innerHTML = event['quantity'];
                                  ;
                              }
                          }
                      } else {
                          alert("Error communicating with server: " + request.status);
                      }
                  };
                  //Set up and send request
                  request.open("POST", "PHP_Orders/get_order_items.php");
                  request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                  request.send("idorder=" + id);
              }

              function search_orders() {
                  var name = document.getElementById("ordersearch").value;

                  if (name === "") {
                    get_orders("ALL");
                      document.getElementById("table-orders").style.display="block";
                  } else {
                      get_orders(name);
                  }
              }


        </script>
    </head>
    <body>
    <center>
      <h2>Orders</h2>
        <div id="orders">
            Search Order<br>
            <input type="search" class="search" name="ordersearch" id="ordersearch" oninput="search_orders();" placeholder="Insert order  id, date or a total price"><br><br>
            <table id="table-orders">
                <tr class="header" >
                    <th style="width:50%;">Order Number</th>
                    <th style="width:40%;">Date</th>
                    <th style="width:40%;">total</th>
                </tr>
            </table>

            <br><br>
            <span id="msgorders"></span>
        </div>
        <div id="orders-details" style="display: none">
          Order info <br><br>

          <span id="msgorderdetails"></span><br><br>
          <span id="date"></span>
          <br><br>
          <table id="table-order-details">
              <tr class="header" >
                  <th style="width:50%;">Event Name</th>
                  <th style="width:40%;">Date</th>
                  <th style="width:40%;">Price</th>
                  <th style="width:40%;">Quantity</th>
              </tr>
          </table>
          <br><br>
          <span id="numberofitems"></span>
          <br>
          <span id="total"></span>



          <a onclick="visibility(['orders','orders-details']);">Back</a>
        </div>
        <!-- The Modal -->
        <div id="myModal" class="mesage-box" style="display: none;">
            <!-- Modal content -->
            <div class="mesage-box-content">
                <span class="close">&times;</span>
                <p id="message-box">Some text in the Modal..</p>
            </div>
        </div>
    </center>
</body>
</html>
