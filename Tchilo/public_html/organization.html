<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Organizations</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="layout.css" type="text/css"/>
        <script src="functions.js"></script>
        <base target="_parent">
        <script>
            if ((document.URL.indexOf('file')) >= 0) {
            } else if (top.location === self.location) {
                top.location.href = "home.html"
            }
            function register_org() {
                //Create request object
                var textbox = ["organizationname", "org-description", "org-email", "org-phonenumber"];
                var validation = validation_form(textbox, 'create-response');
                if (validation) {

                    var request = new XMLHttpRequest();
                    //Create event handler that specifies what should happen when server responds
                    request.onload = function () {
                        alert("request status");
                        //Check HTTP status code
                        if (request.status === 200) {
                            alert(request.responseText);
                            //Get data from server
                            var responseData = request.responseText;

                            if (responseData === "Registration successfully") {
                                visibility(['create-icon', 'create-details'])
                            }

                            document.getElementById("create-response").innerHTML = responseData;
                        } else
                            alert("Error communicating with server: " + request.status);
                    };


                    //Set up request with HTTP method and URL
                    request.open("POST", "PHP_Org/add_org.php");
                    request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                    //Extract registration data
                    var orgName = document.getElementById("organizationname").value;
                    var orgDescription = document.getElementById("org-description").value;
                    var orgEmail = document.getElementById("org-email").value;
                    var orgPhonenumber = document.getElementById("org-phonenumber").value;

                    //Send request
                    request.send("orgname=" + orgName +
                            "&description=" + orgDescription +
                            "&email=" + orgEmail +
                            "&phonenumber=" + orgPhonenumber);
                } else {
                    document.getElementById("create-response").innerHTML = "Complete empty fields";
                }
            }

            var line = 0, linesearch = 0;
            var text = "ALL";
            var guestnames = [];
            var evtID, evtTables;
            var promotername, price, total_price, quantity;
            var divs = ['events-1', 'events-2', 'events-3', 'events-search'];
            var colnum = 0, reserves = 0;
            var line = "0";
            window.onload = get_organizations("ALL", "0");
            function get_organizations(orgname, linenumber) {

                var request = new XMLHttpRequest();
                var all_orgs, org;
                //Create event handler that specifies what should happen when server responds
                request.onload = function () {
                    if (request.status === 200) {
                        alert(request.responseText);
                        all_orgs = JSON.parse(request.responseText);
                        if (all_orgs.length === 0) {

                            if (orgname === "ALL") {
                                document.getElementById('message').innerHTML = "No more orgs";
                                linesearch = 0;
                            } else {
                                document.getElementById("orgs-search").innerHTML += "<p id='message-search'></p>";
                                document.getElementById('message-search').innerHTML = "No more orgs";
                            }

                            return;
                        }
                        // Find a <table> element with id="myTable":
                        var table = document.getElementById("table-orgs");

                        if (linenumber === 0) {
                            while (table.rows.length > 1) {
                                table.deleteRow(1);
                            }
                        }

                        for (var i = 0; i < all_orgs.length; i++) {
                            if (colnum === 0) {
                                var row = table.insertRow();
                            }
                            org = all_orgs[i];
                            var btn = document.createElement("A"); // Create a <button> element
                            btn.setAttribute("onclick", 'get_org_details(\'' + org['idorg'] + '\')');
                            btn.setAttribute("class", "view");
                            btn.setAttribute("width", "350");
                            btn.setAttribute("height", "400");
                            var h3 = document.createElement("H3");
                            var title = document.createTextNode(org['orgname']);
                            h3.appendChild(title);
                            var image = document.createElement("IMG");
                            image.setAttribute("src", org['picture']);
                            image.setAttribute("width", "200");
                            image.setAttribute("alt", org['orgname']);
                            var br = document.createElement("BR");
                            btn.appendChild(h3);
                            btn.appendChild(br);
                            btn.appendChild(image);
                            // Append the button to body;
                            if (orgname === "ALL") {
                                var cell1 = row.insertCell(colnum);
                                cell1.insertBefore(btn, cell1.childNodes[0]);
                            } else {
                                var div = document.getElementById("orgs-search");
                                div.insertBefore(btn, div.childNodes[0]);
                            }
                            if (orgname === "ALL") {
                                colnum++;
                                if (colnum === 4) {
                                    colnum = 0;
                                }
                            }
                        }




                    } else {
                        alert("Error communicating with server: " + request.status);
                    }
                };
                //Set up and send request
                request.open("POST", "PHP_Organizations/get_organizations.php");
                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                request.send("orgname=" + orgname
                        + "&linenumber=" + linenumber);
            }

            function search_org() {
                var name = document.getElementById("orgsearch").value;
                if (name === "") {
                    visibility(['orgs', 'orgs-search']);
                    alert("all");
                    text = "ALL";
                    document.getElementById("orgs-search").innerHTML = "<p id='message-search'></p>";
                } else {

                    document.getElementById("orgs-search").innerHTML = "<p id='message-search'></p>";
                    get_organizations(name);
                    visibility(['orgs-search', 'orgs']);
                    alert("name");
                    text = name;
                }
            }


            function get_org_details(id) {

                var request = new XMLHttpRequest();
                var org;
                //Create event handler that specifies what should happen when server responds
                request.onload = function () {
                    if (request.status === 200) {
                        alert(request.responseText);
                        org = JSON.parse(request.responseText);
                        if (org.hasOwnProperty("message")) {
                            document.getElementById("message").innerHTML = org["message"];
                        } else {

                            document.getElementById('view-organizationname').innerHTML = org['orgname'];
                            document.getElementById('view-org-description').innerHTML = org['description'];
                            document.getElementById('view-org-email').innerHTML = org['email'];
                            document.getElementById('view-org-phonenumber').innerHTML = org['phonenumber'];
                            document.getElementById('view-org-image').src = org['icon'];
                            visibility(['vieworgsinfo', 'vieworgs']);
                            get_org_events(id);
                        }
                    } else {
                        alert("Error communicating with server: " + request.status);
                    }
                };
                //Set up and send request
                request.open("POST", "PHP_Organizations/get_organization_details.php");
                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                request.send("idorg=" + id);
            }

            function get_org_events(id) {

                var request = new XMLHttpRequest();
                var all_events,event;
                //Create event handler that specifies what should happen when server responds
                request.onload = function () {
                    if (request.status === 200) {
                        alert(request.responseText);
                        all_events = JSON.parse(request.responseText);
                        if (all_events.hasOwnProperty("message")) {
                            document.getElementById("message").innerHTML = all_events["message"];
                        } else {
                            // Find a <table> element with id="myTable":
                            var table = document.getElementById("table-events");
                            while (table.rows.length > 1) {
                                table.deleteRow(1);
                            }
                            for (var i = 0; i < all_events.length; i++) {
                                event = all_events[i];
                                var row = table.insertRow();
                                var cell1 = row.insertCell(0);
                                var cell2 = row.insertCell(1);
                                cell1.innerHTML = event['eventname'];
                                cell2.innerHTML = event['dateofevent'];
                                row.setAttribute("onclick", "get_event_details(" + event['idevent'] + ");");
                            }


                        }
                    } else {
                        alert("Error communicating with server: " + request.status);
                    }
                };
                //Set up and send request
                request.open("POST", "PHP_Organizations/get_organization_events.php");
                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                request.send("idorg=" + id);
            }

        </script>
    </head>
    <body>
    <center>

        <div id='vieworgs'>
            <div style="position: fixed; height: 100px;">

                <a onclick="visibility(['createorg', 'vieworgs'])" style="float: right; margin: 3%;">Create Org</a>
                <input type="search" class="search" name="orgsearch" id="orgsearch" oninput="search_org();" placeholder="search for orgs..." >
            </div><br><br><br><br><br><br><br><br><br><br>



            <div id='orgs' style="padding: 0%;">
                <table id="table-orgs">
                    <tr class="header" >
                        <th style="width:30%;">1</th>
                        <th style="width:30%;">2</th>
                        <th style="width:30%;">3</th>
                        <th style="width:30%;">4</th>
                    </tr>
                </table>
                <p id='message'></p>
            </div>
            <div id='orgs-search' style="padding: 0%;display: none">
                <p id='message-search'></p>
            </div>
        </div>
        <div id='vieworgsinfo' style="display:none;">

            <a  onclick="visibility(['vieworgs', 'vieworgsinfo'])" style="float: left;">back</a><br><br><br><br><br><br><br>

            <span id="view-organizationname"></span>
            <br><br>
            <img alt="org icon" src="" id='view-org-image' width="400">
            <br><br>

            Description:<br>
            <span id="view-org-description"></span>
            <br><br>
            Email:
            <span id="view-org-email"></span><br>
            Phone number:
            <span id="view-org-phonenumber"></span>
            <br><br><br>
            Events<br>
            <table id="table-events">
                <tr class="header" >
                    <th style="width:50%;">Name</th>
                    <th style="width:40%;">Date</th>
                </tr>
            </table>

        </div>

        <div id="createorg" style="display: none;">
            <a  onclick="visibility(['vieworgs', 'createorg'])" style="float: left;">Cancel</a><br><br><br><br><br><br><br>

            <span id='create-response'>msg</span><br>
            <div id="create-details" style=" height: 400px">
                <h4>Details</h4>
                <form>
                    <br><strong>
                        Organization name:<br>
                        <input type="text"  name="organizationname" id="organizationname" required>
                        <br><br>
                        Organization description:<br>
                        <textarea rows="4" cols="50" name="org-description" id="org-description" required></textarea>
                        <br><br>
                        Email:
                        <input type="email" name="org-emaail" id="org-email" required><br><br>
                        Phone number:
                        <input type="text" name="org-phonenumber" id="org-phonenumber" required>
                    </strong>
                </form>
                <a onclick="register_org();">Submit</a>
            </div>
            <div id="create-icon" style="height: 400px; display: none;">
                <form action="PHP_Org/upload_org_image.php" method="post" enctype="multipart/form-data" target="view_imageToUpload">
                    Select image to upload:
                    <input type="file" name="imageToUpload" id="org-image">
                    <input type="submit" value="Upload Image" name="submit">
                </form>
                <iframe style="width: 390px; height: 300px;" name="view_imageToUpload"></iframe>
                You can skip this step just click on "Go to Org"
                <a href="myorg.html">Go to Org</a>
            </div>
        </div>
    </center>
</body>
</html>
